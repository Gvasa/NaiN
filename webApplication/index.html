<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.border {
  border:solid;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}
.selectedOne {
    fill: red;
}
.selectedTwo {
    fill: red;
}
.graphs {
  height:250px;
}

#info {
  height:500px;
}

#title, #controlpanel{
  text-align: center;
}

#network {
  height:350px;
}

.dot {
  stroke: #000;
}

</style>
<head>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
</head>
<body>
  <div class="row">
    <div class="col-xs-10">
      <h1 id="title">Visar nu alla generationer</h1>
    </div>
  </div>
  <div class="row">
    <div id="controlpanel" class="col-xs-10">
      <button id="buttonBack" class="btn btn-success"><-</button>
      <span>Generation</span>
      <button id="buttonForward" class="btn btn-success">-></button>
    </div>
  </div>
  <div class="row">
    <div id="graph" class="col-xs-10">
      <div id="one" class="graphs border"></div>
      <div id="two" class="graphs border"></div>
    </div>
    <div id="info" class="col-xs-2 border">
      <table class="table col-xs-12">
        <tbody>
          <tr><td colspan="2">Allmänt</td></tr>
          <tr>
            <td>Fitness</td>
            <td id="fitness">-</td>
          </tr>
          <tr>
            <td>#Länkar</td>
            <td id="NumLink">-</td>
          </tr>
          <tr>
            <td>MaxNeuron</td>
            <td id="NumNeuron">-</td>
          </tr>
          <tr><td colspan="2">Mutation</td></tr>
          <tr>
            <td>Bias</td>
            <td id="bias">-</td>
          </tr>
          <tr>
            <td>Disable</td>
            <td id="disable">-</td>
          </tr>
          <tr>
            <td>Enable</td>
            <td id="enable">-</td>
          </tr>
          <tr>
            <td>Link</td>
            <td id="link">-</td>
          </tr>
          <tr>
            <td>Connection</td>
            <td id="connection">-</td>
          </tr>
          <tr>
            <td>Node</td>
            <td id="node">-</td>
          </tr>
        <tbody>
      </table>
    </div>
  </div>
  <div class="row">
    <div id="network" class="col-xs-12 border">
      <canvas id="myNetwork" width="1000" height="300" style="border:1px solid #d3d3d3;"></canvas>
    <div>
  </div>

<script>

//------------------------------------------------------------------------------------//

var generations = [];
var NUM_OF_GENERATIONS = 10, currentGeneration = 0, currentSpeices = 0;
var margin = {top: 20, right: 20, bottom: 50, left: 50};
var width = document.getElementById('one').offsetWidth - margin.left - margin.right;
var height = document.getElementById('one').offsetHeight - margin.top - margin.bottom;
    // width = 960 - margin.left - margin.right,
    // height = 300 - margin.top - margin.bottom;

//------------------------------------------------------------------------------------//
var xScale1 = d3.scale.linear().range([0, width]);
var yScale1 = d3.scale.linear().range([height, 0]);

var xAxis1 = d3.svg.axis().scale(xScale1).ticks(NUM_OF_GENERATIONS-1).orient("bottom");
var yAxis1 = d3.svg.axis().scale(yScale1).orient("left");

var line1 = d3.svg.line()
    .x(function(g) { return xScale1(g.generation); })
    .y(function(g) { return yScale1(g.maxFitness); });

//------------------------------------------------------------------------------------//

var xScale2 = d3.scale.linear().range([0, width]);
var yScale2 = d3.scale.linear().range([height, 0]);

var xAxis2 = d3.svg.axis().scale(xScale2).orient("bottom");
var yAxis2 = d3.svg.axis().scale(yScale2).orient("left");

var line2 = d3.svg.line()
    .x(function(s,i) { return xScale2(i); })
    .y(function(s) { return yScale2(s.topFitness); });

//------------------------------------------------------------------------------------//


for(var i = 1; i <= NUM_OF_GENERATIONS; i++) {
  d3.json("Test3/generation-"+i+".json", 
    function(error, data) {
      if(error) throw error;

      generations.push(data);
      if(generations.length == NUM_OF_GENERATIONS) {
        setGenerationGraph();
      }
  });
}

//------------------------------------------------------------------------------------//

function setGenerationGraph() {


  d3.select("div#one").html("");

  var maxFintessOverallSvg = d3.select("div#one").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Scale the range of the data
  xScale1.domain(d3.extent(generations, function(g) { return g.generation; }));
  yScale1.domain([0, d3.max(generations, function(g) { return g.maxFitness; })]);

  maxFintessOverallSvg.append("path")
    .datum(generations)
    .attr("class", "line")
    .attr("d", line1);

  maxFintessOverallSvg.selectAll(".dot")
    .data(generations)
    .enter().append("circle")
    .attr("class", "dot")
    .attr("class", function(d) {
      if(currentGeneration == d.generation) {
        return "selectedOne";
      } 
    })
    .attr("r", 5.0)
    .attr("cx", function(d) { return xScale1(d.generation); })
    .attr("cy", function(d) { return yScale1(d.maxFitness); })
    .on("click", function(d,i){

      d3.select(".selectedOne").classed("selectedOne", false);
      d3.select(this).classed("selectedOne", true);
      
      currentGeneration = 1+i;
      currentSpeices = 0;

      changeGeneration();
      
    });

  maxFintessOverallSvg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis1)

    maxFintessOverallSvg.append("g")
    .attr("class", "y axis")
    .call(yAxis1)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
        .text("Max Fitness");
}


//------------------------------------------------------------------------------------//

function setSpeciesGraph(species) {

  d3.select("div#two").html("");

  var maxFintessGenerationSvg= d3.select("div#two").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height * 2 + margin.top * 2 + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  // Scale the range of the data
  xScale2.domain(d3.extent(species, function(s,i) { return i; }));
  yScale2.domain([0, d3.max(species, function(s) { return s.topFitness; })]);

  maxFintessGenerationSvg.append("path")
    .datum(species)
    .attr("class", "line")
    .attr("d", line2);

  maxFintessGenerationSvg.selectAll(".dot")
    .data(species)
    .enter().append("circle")
    .attr("class", "dot")
    .attr("r", 3.0)
    .attr("cx", function(s,i) { return xScale2(i); })
    .attr("cy", function(s) { return yScale2(s.topFitness); })
    .on("click", function(d,i){

      d3.select(".selectedTwo").classed("selectedTwo", false);
      d3.select(this).classed("selectedTwo", true);

      var genome = getMaxGenome(d["genomes"]);
      currentSpeices = i+1;
      setInfotext(genome);
      paint(genome);
      setTitle();
    });

  maxFintessGenerationSvg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis2)

  maxFintessGenerationSvg.append("g")
    .attr("class", "y axis")
    .call(yAxis2)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", 6)
    .attr("dy", ".71em")
    .style("text-anchor", "end")
    .text("Max Fitness");
}

function changeGeneration() {
  setSpeciesGraph(generations[currentGeneration]["species"]);
  setTitle(generations[currentGeneration]["species"], 1);
}  

function getMaxGenome(genomes) {
  var genome = genomes[0];

  for(var index=0; index < genomes.length; index++) {

    if(genome["fitness"] < genomes[index]["fitness"]) {
      genome = genomes[index];
    }
  }
  return genome;
}

function paint(genome) {
  var network = genome["network"]["neurons"];

  var c = document.getElementById("myNetwork");
  var ctxFill = c.getContext("2d");
  var boxSize = 10, index;

  for(var x = 0; x < 13; x++) {
    for(var y = 0; y < 13; y++) {
      index = (x+13*y)+1;

      if(network[index]["value"] == 1) {
        ctxFill.fillStyle="white";
      } else {
        ctxFill.fillStyle="black";
      }
      
      ctxFill.fillRect(x*boxSize+30, y*boxSize+70, boxSize, boxSize);
    }
  }
}

function setTitle() {
  if(currentSpeices != 0){
    document.getElementById("title").innerHTML = "Visar nu generation: " +currentGeneration+ " ras: " + currentSpeices;
  } else {
    document.getElementById("title").innerHTML = "Visar nu generation: " +currentGeneration+ " och alla raser"
  } 
}

function setInfotext(genome) {
  document.getElementById("fitness").innerHTML = genome["fitness"];
  document.getElementById("NumLink").innerHTML = genome["links"].length;
  document.getElementById("NumNeuron").innerHTML = genome["maxNeuron"];
  document.getElementById("bias").innerHTML = genome["mutationRates"]["biasMutationChance"];
  document.getElementById("disable").innerHTML = genome["mutationRates"]["disableMutationChance"];
  document.getElementById("enable").innerHTML = genome["mutationRates"]["enableMutationChance"];
  document.getElementById("link").innerHTML = genome["mutationRates"]["linkMutationChance"];
  document.getElementById("connection").innerHTML = genome["mutationRates"]["mutateConnectionChance"];
  document.getElementById("node").innerHTML = genome["mutationRates"]["nodeMutationChance"];
}

$( "#buttonBack" ).click(function() {
  if(currentGeneration > 1) {
    currentGeneration--;
    setGenerationGraph();
    changeGeneration();
  }
});
$( "#buttonForward" ).click(function() {
  if(currentGeneration < NUM_OF_GENERATIONS-1) {
    currentGeneration++;   
    setGenerationGraph();
    changeGeneration() 
  }
});
</script>
</body>